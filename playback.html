<!doctype html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
        <style>
            #playbackWindow {
                height: calc(100vh - 140px);
                /* overflow-y: scroll; */
            }
            /* Create an active/current tablink class */
            .tab button.active {
            background-color: #ccc;
            }
            /* Style the tab content */
            .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
            }
        </style>

    <title>Experimental Playback UI</title>
    </head>
    <h5>Storyteller</h5>
    <body>
        <div class="container-fluid">
            <!--Create Tabs-->
            <div class="tab">
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="#Playback" role="tab" data-toggle="tab"><p id="fileName"></p></a>
                    </li>
                  </ul>
            </div>

            <div class="tab-content">
                <div id="Playback">
                    <div id="playbackWindow"></div>
                </div>
            </div>

            <!-- minimal controls -->
            <div id="playbackControls">
                <input type="range" id="playbackSlider" min="0" value="0" class="custom-range"/>
                <button id="stepBackOne" class="btn btn-light">&lt;</button>
                <button id="stepForwardOne" class="btn btn-light">&gt;</button>
                <button id="restartButton" class="btn btn-danger">Restart</button>
                <button id="highlightButton" class="btn btn-success">Add Highlight</button>
            </div>    
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/ace.js" type="text/javascript" charset="utf-8"></script>
        <!-- <script src="smallEvents.js"></script> -->
        <!-- <script src="mediumEvents.js"></script> -->
        <script src="largeEvents.js"></script>

        <script>
            //make the div with the id, editor, an ace editor
            const editor = ace.edit("playbackWindow");
            editor.setTheme("ace/theme/monokai");
            editor.setFontSize(16);
            editor.session.setMode("ace/mode/javascript");
            editor.setShowPrintMargin(false);
        </script>



        <script>

            //import the Range type from ace (don't use the built in browser Range type)
            const Range = ace.require('ace/range').Range;

            //holds the ids of all the markers (highlights)
            let allHighlights = [];

            //indicates whether the change can from the textarea not editing in ace
            let changeOutsideEditor = false;

            /*
             * Create a highlight (ace calls these 'markers')
             */
            function addHighlight(startRow, startColumn, endRow, endColumn) {
                //clear any existing highlights
                clearHighlights();

                //create a marker in the right range
                const marker = editor.getSession().addMarker(new Range(startRow, startColumn, endRow, endColumn), 'highlight', 'text', true);
                
                //add the id of the new marker so it can be cleared later
                allHighlights.push(marker);
            }

             /*
             * Function to clear all the highlights.
             */
            function clearHighlights() {
                //go through the collection of marker ids
                for(let i = 0;i < allHighlights.length;i++) {
                    //remove the marker
                    editor.getSession().removeMarker(allHighlights[i]);
                }
                //empty the collection of marker ids
                allHighlights = [];
            }
            
            //the position of the event to play next in the forward direction
            //this refers to an object loaded in the script above, 'eventsObject'
            //which has a property called 'events' which is an array of storyteller
            //events 
            let nextEventPosition = 0;
            //DEBUG
            console.log(`There are ${eventsObject.events.length} events in the array`);

            document.addEventListener("DOMContentLoaded", event => {
                //get the controls
                const stepBackOne = document.getElementById("stepBackOne");
                const stepForwardOne = document.getElementById("stepForwardOne");
                const restartButton = document.getElementById("restartButton");
                const playbackSlider = document.getElementById("playbackSlider");
                const highlightButton = document.getElementById("highlightButton");
                //set the max slider value
                playbackSlider.setAttribute("max", eventsObject.events.length);
                
                //add event handlers for clicking the buttons
                stepBackOne.addEventListener("click", event => {
                    step(-1);
                });

                stepForwardOne.addEventListener("click", event => {
                    step(1);
                });

                restartButton.addEventListener("click", event => {
                    //get the playback window div
                    const playbackWindow = document.getElementById('playbackWindow');
                    
                    //reset the next event and the slider
                    nextEventPosition = 0;
                    playbackSlider.value = 0;

                    //for measuring which approach is faster
                    //get the starting timestamp
                    const t0 = performance.now();

                    //completely clear the div
                    playbackWindow.innerHTML = '';

                    //another way of clearing the elements in a div
                    // while (playbackWindow.firstChild) {
                    //     playbackWindow.removeChild(playbackWindow.firstChild);
                    // }

                    //get the ending timestamp
                    const t1 = performance.now();

                    //print the duration in ms
                    console.log(`Duration ${(t1 - t0)} ms`);
                });

                //add event handler to listen for changes to the slider
                playbackSlider.addEventListener("input", event => {
                    //DEBUG
                    // console.log(`slide: ${playbackSlider.value}`);
                    
                    //take the slider value and subtract the next event's position
                    step(playbackSlider.value - nextEventPosition);
                });
            });

            highlightButton.addEventListener("click", event =>{
                //get the selected code
                const selection = editor.getSession().getSelection().getRange();
                // const selection = editor.getSession().getSelection().getAllRanges();

                //add the highlight to the selected code
                addHighlight(selection.start.row, selection.start.column, selection.end.row, selection.end.column);

            });

            function step(numSteps) {
                //move forward
                if(numSteps > 0) {
                    stepForward(numSteps);
                } else if(numSteps < 0) { //move backward
                    stepBackward(-numSteps);
                } //else- no need to move at all
                
                //update the position of the slider
                playbackSlider.value = nextEventPosition;
            }

            function stepForward(numSteps) {
                //if there is room to move in the forward direction
                if(nextEventPosition < eventsObject.events.length) {
                    //holds the next event to animate
                    let nextEvent;
                
                    //get a reference to the playback window
                    const playbackWindow = document.getElementById('playbackWindow');

                    const t0 = performance.now();


                    //go through the requested number of steps
                    for(let i = 0;i < numSteps;i++) {
                        //grab the next event to animate
                        nextEvent = eventsObject.events[nextEventPosition];
                        if (nextEvent.type == "INSERT"){
                            if(nextEvent.character.length == 1){
                                editor.getSession().insert({row: nextEvent.lineNumber -1,column: nextEvent.column -1}, nextEvent.character);
                            }
                            else if (nextEvent.character == "NEWLINE"){
                                editor.getSession().insert({row: nextEvent.lineNumber -1,column: nextEvent.column -1}, '\n');
                            }

                        }
                        else if (nextEvent.type == "DELETE"){
                            if (nextEvent.character == "NEWLINE"){
                                editor.getSession().remove(new Range(nextEvent.lineNumber-1, nextEvent.column-1,nextEvent.lineNumber, 0));
                            }
                            else if (nextEvent.character.length == 1){
                                editor.getSession().remove(new Range(nextEvent.lineNumber-1, nextEvent.column-1,nextEvent.lineNumber-1, nextEvent.column));
                            }
                        }

                        

                        
                        //move the next event
                        nextEventPosition++;

                        //if we played the last event
                        if(nextEventPosition === eventsObject.events.length) {
                            break;
                        }
                    }

                    const t1 = performance.now();
                    console.log(`step forward took: ${t1-t0} ms`);
                }
            }

            function stepBackward(numSteps) {
                //if there is room to move backwards
                if(nextEventPosition > 0) {
                    //holds the next event to animate
                    let nextEvent;

                    //to account for the fact that nextEventPosition always 
                    //refers to the next event to animate in the forward 
                    //direction I move it back by one position
                    nextEventPosition--;

                    //get a reference to the playback window
                    const playbackWindow = document.getElementById('playbackWindow');

                    //go through the requested number of steps
                    for(let i = 0;i < numSteps;i++) {
                        //grab the next event to de-animate
                        nextEvent = eventsObject.events[nextEventPosition];

                        if (nextEvent.type == "INSERT"){
                            if (nextEvent.character == "NEWLINE"){
                                editor.getSession().remove(new Range(nextEvent.lineNumber-1, nextEvent.column-1,nextEvent.lineNumber, 0));
                            }
                            else if (nextEvent.character.length == 1){
                                editor.getSession().remove(new Range(nextEvent.lineNumber-1, nextEvent.column-1,nextEvent.lineNumber-1, nextEvent.column));
                            }
                        }
                        else if (nextEvent.type == "DELETE"){
                            if(nextEvent.character.length == 1){
                                editor.getSession().insert({row: nextEvent.lineNumber -1,column: nextEvent.column -1}, nextEvent.character);
                            }
                            else if (nextEvent.character == "NEWLINE"){
                                editor.getSession().insert({row: nextEvent.lineNumber -1,column: nextEvent.column -1}, '\n');
                            }                        }

                        //move to the previous event
                        nextEventPosition--;

                        //if we just played back the first event and then decremented
                        if(nextEventPosition < 0) {
                            break;
                        }
                    }

                    //after moving backwards, account for the fact that this
                    //always refers to the next index to animate in the forward
                    //direction
                    nextEventPosition++;
                }
            }

            function getEventDescription(event) {
                //get the event type
                let retVal = event.type;

                //add some data specific to the event
                if(event.type === 'CREATE DIRECTORY') {
                    retVal += ` '${event.directoryPath}'`;
                } else if(event.type === 'CREATE FILE') {
                    retVal += ` '${event.filePath}'`;
                } else if(event.type === 'INSERT' ||
                          event.type === 'DELETE') {
                    retVal += ` '${event.character}'`;
                }

                return retVal;
            }
        </script>
        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    </body>
</html>